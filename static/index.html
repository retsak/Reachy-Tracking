<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reachy Control</title>
    <link rel="stylesheet" href="/static/style.css?v=2">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
</head>

<body>

    <div class="dashboard">
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         HEADER
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <header class="header">
            <h1>ü§ñ Reachy Control</h1>
            <div class="header-controls">
                <div class="theme-selector">
                    <label for="theme-select">üé®</label>
                    <select id="theme-select">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                        <option value="ocean">Ocean</option>
                        <option value="forest">Forest</option>
                    </select>
                </div>
                <div class="header-status">
                    <span><span class="status-dot"></span><span id="status-text">Ready</span></span>
                    <span>üîå Connected</span>
                </div>
            </div>
        </header>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         LEFT SIDEBAR - Quick Actions
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="panel sidebar-left">
            <div class="panel-title">Quick Actions</div>
            <div class="panel-content">
                <div class="action-list">
                    <button class="action-btn" id="wiggle-btn">
                        <span class="icon">üé≠</span> Wiggle Mode
                    </button>
                    <button class="action-btn" id="pause-btn">
                        <span class="icon">‚è∏Ô∏è</span> Pause Tracking
                    </button>
                    <button class="action-btn" id="reset-btn">
                        <span class="icon">üîÑ</span> Reset Position
                    </button>
                    <button class="action-btn" id="voice-btn">
                        <span class="icon">üé§</span> Voice Assistant
                    </button>
                </div>

                <div style="margin-top:24px;">
                    <div class="panel-title" style="padding:0; border:none; margin-bottom:12px;">Motor Mode</div>
                    <div class="action-list">
                        <button class="action-btn" onclick="setMotorMode('stiff')">
                            <span class="icon">üí™</span> Stiff
                        </button>
                        <button class="action-btn" onclick="setMotorMode('soft')">
                            <span class="icon">‚òÅÔ∏è</span> Soft
                        </button>
                        <button class="action-btn" onclick="setMotorMode('limp')">
                            <span class="icon">üí§</span> Limp
                        </button>
                    </div>
                </div>

                <div style="margin-top:auto; padding-top:24px;">
                    <button class="action-btn danger" id="power-btn">
                        <span class="icon">‚õî</span> Shutdown
                    </button>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CENTER - Video + Manual Controls
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="main-center">
            <!-- Video Panel - COMPACT -->
            <div class="panel video-panel">
                <div class="video-frame">
                    <img src="/video_feed" alt="Video Feed" id="video-feed">
                    <div class="video-label">LIVE FEED</div>
                </div>
            </div>

            <!-- Manual Controls -->
            <div class="panel controls-panel">
                <div class="panel-title">Manual Control</div>
                <div class="panel-content">
                    <div id="manual-overlay" style="opacity:0.4; pointer-events:none;">
                        <div class="control-grid">
                        <div class="control-group">
                            <h4>Antennas</h4>
                            <div class="slider-row">
                                <div class="slider-label"><span>Left</span><span class="slider-val"
                                        id="val-ant-l">0¬∞</span></div>
                                <input type="range" id="ant-l" min="-180" max="180" value="0">
                            </div>
                            <div class="slider-row">
                                <div class="slider-label"><span>Right</span><span class="slider-val"
                                        id="val-ant-r">0¬∞</span></div>
                                <input type="range" id="ant-r" min="-180" max="180" value="0">
                            </div>
                        </div>

                        <div class="control-group">
                            <h4>Head</h4>
                            <div class="slider-row">
                                <div class="slider-label"><span>Yaw</span><span class="slider-val"
                                        id="val-head-y">0¬∞</span></div>
                                <input type="range" id="head-y" min="-90" max="90" value="0">
                            </div>
                            <div class="slider-row">
                                <div class="slider-label"><span>Pitch</span><span class="slider-val"
                                        id="val-head-p">0¬∞</span></div>
                                <input type="range" id="head-p" min="-45" max="45" value="0">
                            </div>
                            <div class="slider-row">
                                <div class="slider-label"><span>Roll</span><span class="slider-val"
                                        id="val-head-r">0¬∞</span></div>
                                <input type="range" id="head-r" min="-45" max="45" value="0">
                            </div>
                        </div>

                        <div class="control-group">
                            <h4>Body</h4>
                            <div class="slider-row">
                                <div class="slider-label"><span>Body Yaw</span><span class="slider-val"
                                        id="val-body-y">0¬∞</span></div>
                                <input type="range" id="body-y" min="-150" max="150" value="0">
                            </div>
                        </div>

                        <div class="control-group">
                            <h4>Emotions</h4>
                            <div class="emotion-actions">
                                <button onclick="triggerEmotion('yes')" class="action-btn" title="Yes">üëç</button>
                                <button onclick="triggerEmotion('no')" class="action-btn" title="No">üëé</button>
                                <button onclick="triggerEmotion('happy')" class="action-btn" title="Happy">üòÑ</button>
                                <button onclick="triggerEmotion('sad')" class="action-btn" title="Sad">üò¢</button>
                                <button onclick="triggerEmotion('confused')" class="action-btn" title="Confused">üòï</button>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Voice controls should stay usable even when manual control is off -->
                    <div class="voice-controls">
                        <div class="control-group">
                            <h4>Voice Volume</h4>
                            <div class="slider-row">
                                <div class="slider-label"><span>Level</span><span class="slider-val" id="volume-val">50%</span></div>
                                <input type="range" id="volume-slider" min="0" max="100" value="50">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         RIGHT SIDEBAR - Chat + Data
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="sidebar-right">
            <!-- Chat -->
            <div class="panel chat-panel">
                <div class="panel-title">Chat with Reachy</div>
                <div class="chat-messages" id="chat-messages">
                    <div class="msg msg-assistant">Hello! How can I help?</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button id="chat-send">Send</button>
                </div>
            </div>

            <!-- Tracking Data -->
            <div class="panel data-panel">
                <div class="panel-title">Live Tracking</div>
                <div class="panel-content" style="padding:0;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Class</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody id="candidates-body"></tbody>
                    </table>
                    <div id="no-targets"
                        style="padding:16px; text-align:center; color:var(--text-muted); font-size:12px;">
                        No targets detected
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        let isPaused = false, voiceEnabled = false, wiggleEnabled = false;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHAT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function addMsg(role, text) {
            const el = document.createElement('div');
            el.className = `msg msg-${role}`;
            el.textContent = text;
            $('chat-messages').appendChild(el);
            $('chat-messages').scrollTop = $('chat-messages').scrollHeight;
        }

        $('chat-send').onclick = async () => {
            const input = $('chat-input');
            const text = input.value.trim();
            if (!text) return;
            addMsg('user', text);
            input.value = '';
            try {
                const res = await fetch('/api/voice/text_command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, speak: true })
                });
                const data = await res.json();
                if (data.response) addMsg('assistant', data.response);
            } catch (e) {
                addMsg('system', 'Error sending message');
            }
        };

        $('chat-input').onkeypress = e => { if (e.key === 'Enter') $('chat-send').click(); };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ACTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        $('reset-btn').onclick = () => fetch('/api/reset', { method: 'POST' });

        $('pause-btn').onclick = async () => {
            const res = await fetch('/api/toggle_pause', { method: 'POST' });
            const data = await res.json();
            isPaused = data.paused;
            updatePauseUI();
        };

        function updatePauseUI() {
            const btn = $('pause-btn');
            const overlay = $('manual-overlay');
            if (isPaused) {
                btn.classList.add('active');
                btn.innerHTML = '<span class="icon">‚ñ∂Ô∏è</span> Resume';
                overlay.style.opacity = '1';
                overlay.style.pointerEvents = 'auto';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<span class="icon">‚è∏Ô∏è</span> Pause Tracking';
                overlay.style.opacity = '0.4';
                overlay.style.pointerEvents = 'none';
            }
        }

        $('wiggle-btn').onclick = async () => {
            await fetch('/api/toggle_wiggle', { method: 'POST' });
        };

        async function triggerEmotion(emotion) {
            try {
                await fetch('/api/emote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emotion })
                });
            } catch (e) { console.error(e); }
        }

        $('voice-btn').onclick = async () => {
            const ep = voiceEnabled ? '/api/voice/disable' : '/api/voice/enable';
            const res = await fetch(ep, { method: 'POST' });
            const data = await res.json();
            voiceEnabled = data.voice_enabled;
            $('voice-btn').classList.toggle('active', voiceEnabled);
        };

        $('power-btn').onclick = async () => {
            if (confirm('Shutdown the system?')) {
                await fetch('/api/shutdown', { method: 'POST' });
                document.body.innerHTML = '<div style="display:flex;height:100vh;align-items:center;justify-content:center;color:#fff;font-family:sans-serif;"><h1>System Offline</h1></div>';
            }
        };

        window.setMotorMode = mode => {
            fetch('/api/motor_mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode })
            });
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SLIDERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const sliders = ['ant-l', 'ant-r', 'head-y', 'head-p', 'head-r', 'body-y'];
        const active = new Set();

        sliders.forEach(id => {
            const el = $(id), val = $('val-' + id);
            el.oninput = () => val.textContent = el.value + '¬∞';
            el.onmousedown = () => active.add(id);
            el.onmouseup = () => { active.delete(id); sendManual(); };
            el.ontouchstart = () => active.add(id);
            el.ontouchend = () => { active.delete(id); sendManual(); };
        });

        function sendManual() {
            if (!isPaused) return;
            fetch('/api/manual_control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    antenna_left: +$('ant-l').value,
                    antenna_right: +$('ant-r').value,
                    head_yaw: +$('head-y').value,
                    head_pitch: +$('head-p').value,
                    head_roll: +$('head-r').value,
                    body_yaw: +$('body-y').value
                })
            });
        }

        // Volume
        $('volume-slider').oninput = e => $('volume-val').textContent = e.target.value + '%';
        $('volume-slider').onchange = e => {
            fetch('/api/voice/volume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ volume: +e.target.value })
            });
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // THEME SELECTION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function initTheme() {
            const saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            $('theme-select').value = saved;
        }
        
        $('theme-select').onchange = e => {
            const theme = e.target.value;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        };
        
        initTheme();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // POLLING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        setInterval(async () => {
            try {
                const res = await fetch('/status');
                const data = await res.json();

                // Status
                $('status-text').textContent = data.status || 'Ready';

                // Wiggle
                wiggleEnabled = data.wiggle_enabled;
                $('wiggle-btn').classList.toggle('active', wiggleEnabled);

                // Pause sync
                if (data.paused !== undefined && data.paused !== isPaused) {
                    isPaused = data.paused;
                    updatePauseUI();
                }

                // Candidates
                const tbody = $('candidates-body');
                const noT = $('no-targets');
                if (data.candidates?.length) {
                    noT.style.display = 'none';
                    tbody.innerHTML = '';
                    data.candidates.sort((a, b) => b.score - a.score).slice(0, 5).forEach(c => {
                        const tr = document.createElement('tr');
                        if (c.id == data.current_target_id) tr.classList.add('active');
                        tr.innerHTML = `<td>#${c.id}</td><td>${c.label}</td><td>${Math.round(c.score)}</td>`;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '';
                    noT.style.display = 'block';
                }

                // Slider sync
                if (data.pose) {
                    const deg = r => (r * 180 / Math.PI);
                    const map = {
                        'ant-l': data.pose.antenna_left,
                        'ant-r': data.pose.antenna_right,
                        'head-y': deg(data.pose.head_yaw),
                        'head-p': deg(data.pose.head_pitch),
                        'head-r': deg(data.pose.head_roll),
                        'body-y': deg(data.pose.body_yaw)
                    };
                    for (const [id, v] of Object.entries(map)) {
                        if (!active.has(id)) {
                            $(id).value = v;
                            $('val-' + id).textContent = Math.round(v) + '¬∞';
                        }
                    }
                }

                // Voice polling
                if (voiceEnabled) {
                    const vr = await fetch('/api/voice/status');
                    const vd = await vr.json();
                    if (vd.conversation_history?.length) {
                        const last = vd.conversation_history[vd.conversation_history.length - 1];
                        if (last.role === 'assistant' && window.lastA !== last.content) {
                            window.lastA = last.content;
                            addMsg('assistant', last.content);
                        }
                    }
                }
            } catch (e) { }
        }, 500);
    </script>
</body>

</html>